<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leaflet Media Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }

    .realTarget{
      width:18px;height:18px;border-radius:50%;
      background:#23c552; border:2px solid #fff;
      box-shadow:0 6px 18px rgba(0,0,0,0.35);
    }

    /* Route info box (hover + click lock) */
    #routeInfo {
      position: absolute;
      left: 16px;
      top: 16px;
      z-index: 1200;
      background: rgba(10,10,10,0.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      font-family: system-ui, sans-serif;
      display: none;
      max-width: calc(100vw - 32px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.35);
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }

    /* Media panel */
    #media {
      position: absolute;
      right: 16px;
      bottom: 16px;
      width: 440px;
      max-width: calc(100vw - 32px);
      background: rgba(10,10,10,0.94);
      color: #fff;
      border-radius: 12px;
      display: none;
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
      font-family: system-ui, sans-serif;
      z-index: 1200;
      overflow: hidden;
    }

    #mediaHeader {
      padding: 12px 14px;
      font-weight: 700;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    #closeBtn {
      background: rgba(255,255,255,0.15);
      border: 0;
      color: #fff;
      border-radius: 6px;
      font-size: 18px;
      cursor: pointer;
      padding: 4px 10px;
      line-height: 1;
    }

    #mediaBody { padding: 12px 14px; }

    .yt-thumb {
      width: 100%;
      border-radius: 10px;
      cursor: pointer;
      display: block;
    }

    .yt-title {
      margin-top: 10px;
      font-weight: 700;
      font-size: 16px;
      line-height: 1.3;
    }

    .yt-link {
      margin-top: 6px;
      font-size: 14px;
      opacity: 0.85;
    }

    .yt-link a {
      color: #fff;
      text-decoration: underline;
    }

    iframe {
      width: 100%;
      height: 248px;
      border: 0;
      border-radius: 10px;
      margin-top: 10px;
      background: #000;
      display: block;
    }

    /* Images */
    .img-main {
      width: 100%;
      border-radius: 10px;
      display: block;
    }

    .thumbRow {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      overflow-x: auto;
      padding-bottom: 6px;
    }

    .thumbRow img {
      width: 78px;
      height: 52px;
      object-fit: cover;
      border-radius: 8px;
      cursor: pointer;
      opacity: 0.9;
    }

    /* Red place markers */
    .hoverTarget {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #ff2d2d;
      border: 2px solid #fff;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="routeInfo" title="Click to lock/unlock"></div>

  <div id="media">
    <div id="mediaHeader">
      <span id="mediaTitle"></span>
      <button id="closeBtn" type="button">×</button>
    </div>
    <div id="mediaBody"></div>
  </div>

  <script>
    // =========================
    // DATA
    // =========================
    const places = [
      { title: "Krubera Cave", lat: 44.86185352391871, lng: 34.52232062535062, youtubeId: "OPUTLWhhqCo", visitType: "virtual" },
      { title: "Hanoi to Sapa Bike Route", lat: 21.02929594764382, lng: 105.83187714081436, youtubeId: "JI_Md14CH0Y", visitType: "virtual" },
      { title: "Mount Everest Summit", lat: 27.989083286129265, lng: 86.9247504130415, youtubeId: "rDYZr8Uz2rE", visitType: "virtual" },
      { title: "Yakutsk, Siberia", lat: 62.0348, lng: 129.7325, youtubeId: ["D-WGGDRyf68","-IaGmGc4iZ4"], images: [], visitType: "virtual" },
      { title: "Western Alaska Bering Sea Coast", lat: 60.0, lng: -165.0, youtubeId: "6FJ-kY7TNA0", visitType: "virtual" },
      { title: "Seoul to Busan Walking", lat: 37.5665, lng: 126.9780, youtubeId: "SmqHKzsske8", visitType: "virtual" },
      { title: "Grampians Trip", lat: -37.22130471693513, lng: 142.5398767885015, video: {type: "gdrive", fileId: "1yConl4qzzfEL4jAFvLdeeHhDLJ3IpSpP"}, instagramReel: {url: "https://www.instagram.com/p/DUfmX4oEgu2/"}, visitType: "real" }
    ];

    // Define routes ONCE
    const routes = [
      {
        id: "hanoi-sapa",
        name: "Hanoi → Sapa",
        visitType: "virtual",     // "real" | "virtual"
        profile: "driving",
        waypoints: [
           { lat: 21.02929594764382, lng: 105.83187714081436, label: "Hanoi" }, // Hanoi
           { lat: 22.336845755166458, lng: 103.84358760428601, label: "Sapa" }  // Sapa
        ]
      },

      {
        id: "seoul-busan",
        name: "Seoul → Busan",
        visitType: "virtual",
        profile: "walking",
        waypoints: [
          { lat: 37.5665, lng: 126.9780, label: "Seoul" },                 // Seoul
          { lat: 37.38709471119551, lng: 126.94158556276203,  label: "Day 2: Anyang" }, // stop
          { lat: 37.18419695965625, lng: 127.07052236653928, label: "Day 3: Osan" },
          { lat: 37.01589539212461, lng: 127.2714951207471, label: "Day 4: Anseong" },
          { lat: 36.823709237560905, lng: 127.17119682672293, label: "Day 5: Cheonan" },
          { lat: 36.61217481486236, lng: 127.30132947621905, label: "Day 7: Jochiwon" },
          { lat: 36.37194168016705, lng: 127.3871150872785, label: "Day 8: Daejeon" },
          { lat: 36.31561716151819, lng: 127.57604825523711, label: "Day 9: Okcheon" },
          { lat: 36.18744871755162, lng: 127.82081938424099, label: "Day 10: Yeongdong" },
          { lat: 36.26472003852306, lng: 127.90249731787617, label: "Day 11: Hwanggan-myeon"},
          { lat: 36.14141409129925, lng: 128.1002412754611, label: "Day 12: Gimcheon" },
          { lat: 36.1280381628173, lng: 128.37317035866388, label: "Day 13: Gumi" },
          { lat: 35.983799668837634, lng: 128.40390300461445, label: "Day 14: Waegwan" },
          { lat: 35.86346101286367, lng: 128.5249893852662, label: "Day 16: Daeju" },
          { lat: 35.83857139570044, lng: 128.7419602267018, label: "Day 17: Gyeongsan" },
          { lat: 35.759580, lng: 128.887703, label: "Day 18: Cheongdo" },
          { lat: 35.491730524999525, lng: 128.7966238006781, label: "Day 19: Miryang" },
          { lat: 35.3144804491319, lng: 128.99424524807057, label: "Day 20: Mulgeum" },
          { lat: 35.1796, lng: 129.0756,  label: "Day 21: Busan" }                  // Busan
        ]
      }
  
      // add more routes here
    ];

    // =========================
    // MAP
    // =========================
    const map = L.map("map", { worldCopyJump: true }).setView([-25, 140], 3);

    const bounds = L.latLngBounds(L.latLng(-85, -180), L.latLng(85, 180));
    map.setMaxBounds(bounds);
    map.on("drag", () => map.panInsideBounds(bounds, { animate: false }));

    const streets = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors",
      noWrap: true,
      bounds
    });

    const satelliteWithLabels = L.layerGroup([
      L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
        maxZoom: 19,
        attribution: "Tiles © Esri",
        noWrap: true,
        bounds
      }),
      L.tileLayer("https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}", {
        maxZoom: 19,
        attribution: "Labels © Esri",
        noWrap: true,
        bounds
      })
    ]);

    streets.addTo(map);

    // =========================
    // TWO TOGGLES: Virtual / Real (each contains visits + routes)
    // =========================
    const virtualGroup = L.layerGroup().addTo(map);
    const realGroup    = L.layerGroup().addTo(map);

    const virtualVisits = L.layerGroup().addTo(virtualGroup);
    const virtualRoutes = L.layerGroup().addTo(virtualGroup);

    const realVisits = L.layerGroup().addTo(realGroup);
    const realRoutes = L.layerGroup().addTo(realGroup);

    L.control.layers(
      { "Streets": streets, "Satellite": satelliteWithLabels },
      { "Virtual visits": virtualGroup, "Real visits": realGroup },
      { position: "topleft" }
    ).addTo(map);

    // =========================
    // ROUTE INFO (hover + click lock)
    // =========================
    const routeInfoEl = document.getElementById("routeInfo");
    let routeLocked = false;
    let routeHover = false;
    let routeSummaryText = "";

    function formatKm(m) { return (m / 1000).toFixed(1) + " km"; }
    function formatTime(s) {
      const h = Math.floor(s / 3600);
      const m = Math.round((s % 3600) / 60);
      return h > 0 ? `${h}h ${m}m` : `${m}m`;
    }
    function showRouteInfo() {
      if (!routeSummaryText) return;
      routeInfoEl.textContent = routeSummaryText + (routeLocked ? " (locked)" : "");
      routeInfoEl.style.display = "block";
    }
    function hideRouteInfoIfAllowed() {
      if (routeLocked) return;
      if (routeHover) return;
      routeInfoEl.style.display = "none";
    }
    routeInfoEl.addEventListener("click", (e) => {
      e.stopPropagation();
      routeLocked = !routeLocked;
      if (routeLocked) showRouteInfo();
      else hideRouteInfoIfAllowed();
    });

    // =========================
    // ROUTES (OSRM) with invisible hitbox
    // =========================
    function routeLayerFor(rt) {
      return rt.visitType === "real" ? realRoutes : virtualRoutes;
    }
    function routeTypeLabel(rt) {
      return rt.visitType === "real" ? "Real route" : "Virtual route";
    }

    function bindRouteHitEvents(hitPolyline, summaryText) {
      hitPolyline.on("mouseover", (e) => {
        L.DomEvent.stop(e);
        routeHover = true;
        routeSummaryText = summaryText;
        showRouteInfo();
      });
      hitPolyline.on("mouseout", (e) => {
        L.DomEvent.stop(e);
        routeHover = false;
        hideRouteInfoIfAllowed();
      });
      hitPolyline.on("click", (e) => {
        L.DomEvent.stop(e);
        routeLocked = !routeLocked;
        routeSummaryText = summaryText;
        showRouteInfo();
      });
    }

    async function fetchOsrmRouteWaypoints(waypoints, profile = "driving") {
    // OSRM expects lon,lat; multiple points separated by ;
    const coords = waypoints.map(p => `${p.lng},${p.lat}`).join(";");

    const url =
      `https://router.project-osrm.org/route/v1/${profile}/` +
      coords +
      `?overview=full&geometries=geojson&alternatives=false&steps=false`;

    const res = await fetch(url, { mode: "cors" });
    if (!res.ok) throw new Error(`OSRM HTTP ${res.status}`);

    const data = await res.json();
    if (!data.routes || !data.routes.length) throw new Error("No routes in OSRM response");

    const r = data.routes[0];
    const latlngs = r.geometry.coordinates.map(([lon, lat]) => [lat, lon]);
    return { latlngs, distance: r.distance, duration: r.duration };
  }

    async function drawRoute(rt) {
      const group = routeLayerFor(rt);

      // waypoint markers
      const wps = rt.waypoints && rt.waypoints.length >= 2
        ? rt.waypoints
        : [rt.a, rt.b].filter(Boolean);

      // waypoint markers + hover city labels
      wps.forEach(p => {
        const mk = L.marker([p.lat, p.lng]).addTo(group);

        if (p.label) {
          mk.bindTooltip(p.label, {
            direction: "top",
            offset: [0, -10],
            opacity: 0.95,
            sticky: true
          });
        }
      });

      try {
        const { latlngs, distance, duration } = await fetchOsrmRouteWaypoints(wps, rt.profile || "driving");

        // visible route
        L.polyline(latlngs, { weight: 6, opacity: 0.9 }).addTo(group);

        // invisible hitbox for hover/click
        const hit = L.polyline(latlngs, { weight: 24, opacity: 0, interactive: true }).addTo(group);

        const summary = `${routeTypeLabel(rt)} • ${rt.name}: ${formatKm(distance)} • ${formatTime(duration)}`;
        bindRouteHitEvents(hit, summary);

      } catch (err) {
        console.error("OSRM route failed:", rt.id, err);

        // dotted fallback ONLY on failure
        const latlngs = wps.map(p => [p.lat, p.lng]);

        L.polyline(latlngs, { weight: 6, opacity: 0.6, dashArray: "6 8" }).addTo(group);
        const hit = L.polyline(latlngs, { weight: 24, opacity: 0, interactive: true }).addTo(group);

        const summary = `${routeTypeLabel(rt)} • ${rt.name}: unavailable • straight-line fallback`;
        bindRouteHitEvents(hit, summary);
      }
    }

    routes.forEach(rt => drawRoute(rt));

    // =========================
    // MEDIA PANEL (multi YouTube + images)
    // =========================
    const mediaEl = document.getElementById("media");
    const titleEl = document.getElementById("mediaTitle");
    const bodyEl = document.getElementById("mediaBody");
    const closeBtn = document.getElementById("closeBtn");

    let mediaLocked = false;
    mediaEl.addEventListener("click", (e) => e.stopPropagation());

    function normalizeYouTubeIds(p) {
      if (Array.isArray(p.youtubeIds)) return p.youtubeIds.filter(Boolean);
      if (Array.isArray(p.youtubeId)) return p.youtubeId.filter(Boolean);
      if (typeof p.youtubeId === "string" && p.youtubeId.trim()) return [p.youtubeId.trim()];
      return [];
    }

    async function fetchYouTubeTitle(videoId) {
      const url = `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("oEmbed failed");
      const data = await res.json();
      return data.title;
    }

    function renderYouTubeGallery(youtubeIds) {
      const list = document.createElement("div");
      list.style.display = "grid";
      list.style.gridTemplateColumns = "1fr";
      list.style.gap = "10px";

      youtubeIds.forEach((id) => {
        const card = document.createElement("div");

        const thumb = document.createElement("img");
        thumb.className = "yt-thumb";
        thumb.src = `https://i.ytimg.com/vi/${id}/hqdefault.jpg`;
        thumb.loading = "lazy";
        thumb.referrerPolicy = "no-referrer";

        const ytTitle = document.createElement("div");
        ytTitle.className = "yt-title";
        ytTitle.textContent = "Loading title…";

        fetchYouTubeTitle(id)
          .then(t => ytTitle.textContent = t)
          .catch(() => ytTitle.textContent = "YouTube Video");

        const link = document.createElement("div");
        link.className = "yt-link";
        link.innerHTML =
          `<a href="https://www.youtube.com/watch?v=${id}" target="_blank" rel="noopener noreferrer">Watch on YouTube</a>`;

        thumb.onclick = () => {
          card.innerHTML = "";
          const iframe = document.createElement("iframe");
          iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
          iframe.allowFullscreen = true;
          iframe.src = `https://www.youtube.com/embed/${id}?autoplay=1&mute=1&playsinline=1`;
          card.appendChild(iframe);
          card.appendChild(link);
        };

        card.appendChild(thumb);
        card.appendChild(ytTitle);
        card.appendChild(link);
        list.appendChild(card);
      });

      bodyEl.appendChild(list);
    }

    function renderImagesGallery(images) {
      const main = document.createElement("img");
      main.className = "img-main";
      main.src = images[0];
      main.loading = "lazy";
      bodyEl.appendChild(main);

      if (images.length > 1) {
        const row = document.createElement("div");
        row.className = "thumbRow";

        images.forEach((src) => {
          const t = document.createElement("img");
          t.src = src;
          t.loading = "lazy";
          t.onclick = () => { main.src = src; };
          row.appendChild(t);
        });

        bodyEl.appendChild(row);
      }
    }

    function renderInstagramReel(reel) {
      const card = document.createElement("div");

      card.style.border = "1px solid rgba(255,255,255,0.15)";
      card.style.borderRadius = "10px";
      card.style.padding = "12px";
      card.style.cursor = "pointer";

      const title = document.createElement("div");
      title.style.fontWeight = "700";
      title.textContent = "Instagram Reel";

      const hint = document.createElement("div");
      hint.style.opacity = "0.8";
      hint.style.fontSize = "14px";
      hint.textContent = "Tap to open in Instagram";

      card.appendChild(title);
      card.appendChild(hint);

      card.onclick = () => {
        window.open(reel.url, "_blank", "noopener");
      };

      bodyEl.appendChild(card);
    }

    function hasVideo(p) {
      return !!(p.video && (
        (p.video.type === "gdrive" && p.video.fileId) ||
        (p.video.type === "local" && p.video.src)
      ));
    }

    function renderDriveVideo(fileId) {
      const iframe = document.createElement("iframe");
      iframe.src = `https://drive.google.com/file/d/${fileId}/preview`;
      iframe.allow = "autoplay";
      iframe.style.width = "100%";
      iframe.style.height = "260px";
      iframe.style.border = "0";
      iframe.style.borderRadius = "10px";
      iframe.style.display = "block";
      bodyEl.appendChild(iframe);
    }

    function renderLocalVideo(src) {
      const v = document.createElement("video");
      v.src = src;
      v.controls = true;
      v.playsInline = true;
      v.style.width = "100%";
      v.style.borderRadius = "10px";
      bodyEl.appendChild(v);
    }

    function renderMedia(p) {
      titleEl.textContent = p.title || "Location";
      bodyEl.innerHTML = "";

      const ytIds = normalizeYouTubeIds(p);
      const imgs = Array.isArray(p.images) ? p.images.filter(Boolean) : [];

      const hasYt = ytIds.length > 0;
      const hasImgs = imgs.length > 0;
      const hasIg = !!(p.instagramReel && p.instagramReel.url);
      const hasVid = hasVideo(p);

      if (!hasYt && !hasImgs && !hasIg && !hasVid) {
        bodyEl.textContent = "No media set for this location.";
        mediaEl.style.display = "block";
        return;
      }

      // Video
      if (hasVid) {
        const h = document.createElement("div");
        h.style.fontWeight = "700";
        h.style.marginBottom = "8px";
        h.textContent = "Video";
        bodyEl.appendChild(h);

        if (p.video.type === "gdrive") renderDriveVideo(p.video.fileId);
        if (p.video.type === "local")  renderLocalVideo(p.video.src);
      }

      // Instagram
      if (hasIg) {
        if (hasVid) {
          const sep = document.createElement("div");
          sep.style.height = "1px";
          sep.style.background = "rgba(255,255,255,0.12)";
          sep.style.margin = "12px 0";
          bodyEl.appendChild(sep);
        }
        const hIg = document.createElement("div");
        hIg.style.fontWeight = "700";
        hIg.style.marginBottom = "8px";
        hIg.textContent = "Instagram";
        bodyEl.appendChild(hIg);

        renderInstagramReel(p.instagramReel);
      }

      // YouTube
      if (hasYt) {
        if (hasVid || hasIg) {
          const sep = document.createElement("div");
          sep.style.height = "1px";
          sep.style.background = "rgba(255,255,255,0.12)";
          sep.style.margin = "12px 0";
          bodyEl.appendChild(sep);
        }
        const hYt = document.createElement("div");
        hYt.style.fontWeight = "700";
        hYt.style.marginBottom = "8px";
        hYt.textContent = "Videos";
        bodyEl.appendChild(hYt);

        renderYouTubeGallery(ytIds);
      }

      // Photos
      if (hasImgs) {
        if (hasVid || hasIg || hasYt) {
          const sep = document.createElement("div");
          sep.style.height = "1px";
          sep.style.background = "rgba(255,255,255,0.12)";
          sep.style.margin = "12px 0";
          bodyEl.appendChild(sep);
        }
        const h2 = document.createElement("div");
        h2.style.fontWeight = "700";
        h2.style.marginBottom = "8px";
        h2.textContent = "Photos";
        bodyEl.appendChild(h2);

        renderImagesGallery(imgs);
      }

      mediaEl.style.display = "block";
    }

    function closeMedia() {
      mediaLocked = false;
      mediaEl.style.display = "none";
      bodyEl.innerHTML = "";
    }

    closeBtn.onclick = (e) => {
      e.stopPropagation();
      closeMedia();
    };

    map.on("click", () => {
      closeMedia();
      routeHover = false;
      hideRouteInfoIfAllowed();
    });

    // =========================
    // PLACE MARKERS (Virtual=red, Real=green) hover + click lock
    // =========================
    const virtualIcon = L.divIcon({
      className: "",
      html: '<div class="hoverTarget"></div>',
      iconSize: [18, 18],
      iconAnchor: [9, 9]
    });

    const realIcon = L.divIcon({
      className: "",
      html: '<div class="realTarget"></div>',
      iconSize: [18, 18],
      iconAnchor: [9, 9]
    });

    places.forEach((p) => {
      const isReal = (p.visitType || "virtual") === "real";
      const icon = isReal ? realIcon : virtualIcon;
      const layer = isReal ? realVisits : virtualVisits;

      const m = L.marker([p.lat, p.lng], { icon }).addTo(layer);

      m.on("mouseover", () => { if (!mediaLocked) renderMedia(p); });
      m.on("mouseout",  () => { if (!mediaLocked) closeMedia(); });

      m.on("click", (e) => {
        e.originalEvent.stopPropagation();
        mediaLocked = !mediaLocked;
        renderMedia(p);
      });
    });
  </script>
</body>
</html>